# @version ^0.3.2

from vyper.interfaces import ERC721
from vyper.interfaces import ERC20

#######################
## Accounting
#######################

allocation: immutable(uint256[118])
taken: HashMap[uint256, uint256]

#######################
## Vesting Time
#######################

startTime: uint256
vestingDuration: uint256

#######################
## External Contracts
#######################

APA: ERC721
FLY: ERC20


@external
def __init__(apa: address, fly: address, startTime: uint256, vestingDuration: uint256):
    self.APA = ERC721(apa)
    self.FLY = ERC20(fly)

    self.startTime = startTime
    self.vestingDuration = vestingDuration

    # check scripts/scraper.py
    allocation = [
        22645903587710383914993889775798176457427603556687181744332709771175011025033,
        7254674109709533405302720250516416151451299365989429885612019982314426663952,
        918871784604517272138319536964857681909706492718885198013841147841298305601,
        924288880468448047981009052860118123822760390458307396176902351110848417856,
        46221858019204812632561015529904358007805546349485517160207738995294077512,
        242058104335217149586766773248927228740499967253859239217626057376813580802,
        224792063696459215740087775370223922256519437327051664857754387236263489,
        226412328329247885801966349515198547127727525615331284065757009445948755992,
        2714567872749533246562584332267823049397677810938554396403233242994945831104,
        7240539757609685454926332725256133767596632657134202351228156483261714924042,
        7479063692633304510650258435359449406243843254097711856332335029357524549697,
        9175271423967547802202347973048606683578034755334179613984453991357632286720,
        8146935273530493465806295421092149509797287013562173291075256543806251635200,
        259950832968342176396165882033251125144737224871176545944991916718498513472,
        8141879738211449401775547440376953462465618762729095214073679389642809708672,
        8254937251014479430378399665224549844678958436348869280263236543450760675392,
        14488145985341654788161104824722731137954121065333518250390964012108937692672,
        1813061159164138616626886033774935434365822763475567562471567830323633848841,
        248948163982879119914044471777238770485983844354389944095931196451618817,
        113161095552170358505629427060356895691191009777783394244307317545880585728,
        7237281654768670264956852756062068855760306834734157807168813083789021413578,
        2717441843500879699970645784098579110796147543888959142963525308884585546240,
        7477300662074457813680364140749206710672451098935972411479307499594404594193,
        14831913577439614390884927913258883708718558612381061546903014719866537472,
        15511402463936108545036770957346398404775826637268480888682934361356813734913,
        9187608194579647497930151026242366769637821335007159296308537710021485899841,
        171670601237154470367786015205793028061398110890399679352034104687609262082,
        7350087254700103374594616724464264676411090992641143198199856858503495811778,
        227867261603439881559691762536999311933332802355367746061873152925151808,
        8256476818991721454597036386255420436288690564034166674166594472244863307848,
        14601224251168586627964357431423598088023462027752562104680139096618705879632,
        127682309222624204087462833519183466166109176723567741219437024697446039562,
        8254709487594482378057123112138232906989646020059273495477211572351550129218,
        1822546448345002362249394530521103076444714410867421825603034782777213440,
        14714357576185377891510060819500547383382419799817079380783537553286633882696,
        29301723438536454021148571629646238625721770084072483549305972867370928046147,
        226156918022216461914191260090294273641002162370177386812441863140898082816,
        8381922913434120291636696111483301563299498685241971001892299548360792150016,
        1131472296092871190382426653279066512428190307738954923002021626266364485633,
        1019471302316047774346738806116500329672942845816866729562783487402350743553,
        15493710261898786677228810714372629721813706524611672640548441091413783875584,
        8173462143843137107802519467969092417885552077198779048777522743242408362048,
        14606524685470925993528551111093835777005290781196802676717881296465579474944,
        8254771610788772967285317108099024455278401720550474569579736098553974522376,
        127217855793376912433359697069309114237287737862795345906593080043020255296,
        7350112273506107906042061648756450990939807338172125235699757466688484807168,
        240512111458852366034543879537166820519185484347587208817055882585284284490,
        2715675105317704536060801602435144816778753669296524272379840032682381672962,
        1922384874488026294566281645317584341338352374857567506447331123867756265608,
        8155769563405795737811714373251534703342472224339761624794630646513330324171,
        1839737285199884727482200483114857855703432191856348574821502399764960117762,
        16509727404451889345307396345444495790865358808473552886149506544308012193856,
        16125991841654941252871349929233746020410360068766582677852532981587051016,
        20097905581846675261207778647999548939110042049548439265539263138644689025,
        919202186295101900984031841663172583809929083183598136643597485321323053576,
        9050097807105769692226356704115727751348188292222871171586855071495477002376,
        8300869714222653576880550982873169479435300833163895207596733222186819781122,
        1159079712844296718060350549596808492314820508368681911493969149919806923272,
        1049538646564901563727437503520720680314448820816302452004624509933938053771,
        1950603096523421377439125183600659510021021383863554155139309128235715137536,
        15491935919980299876103538871608490144025927850484245604754768211059836715592,
        23633788535521109889832038913394593047378797230199728771905179026649682055168,
        1032281691993671262064703584783299578437300517824679834051771106464205898315,
        904877618609152362324560657005547004560668973300627738136529846841259659265,
        1144944990241051616499508584414697952545716684251750599384242145844607091203,
        7467165015454522605226299294438399044174034129280414511143978265793005625360,
        226598567627602720148515111486517638169721556862090541756434731175803618305,
        7353624392110656291686349511484542450356695133694497791313802546223348716104,
        15508065789841987651850096798835188919302852934079243259156089028200108393032,
        673466207790844336978342759526332404535796249368311972795153850824917121,
        7463639193629364228129742226908483511326240253633072351837915477232461152961,
        14719630571068988909861566071278591849375894477775496099417023573915821150224,
        904629154781595454443511957435589843750121596225995751582044031187627319825,
        27606987035882356133627029962582782174302473523878150144294504299266569,
        28038674097647026501179226634392986907297578677601128954700327985156121,
        9163100094341946237694381908888147698458057115295094679037553712690471374929,
        56084485700117046883145917601942029973851580969420472653132085441069059,
        116639573923931941641073308742977433805919038958533430786633426951196418698,
        1837745746158421510314409992229334473459835096347236859369539320713463468545,
        9046312678603145081556079420931778167744527758520422283678726603297452524104,
        22841798853786113675408290238105227635263010904822386382601960550014470094849,
        255088545836336239189905488206070516498498116448085621229396823277111640640,
        8256704093023856840483835437532846873350414732711106456030578181100703581313,
        8141635157693767371777483039368375397161587048246698727830409169251651334666,
        21713008323930184971200938549576883369977624062891842699691194911671068135440,
        7256724298968697062721512283626559256733738719569777352384669434115474886784,
        1019525970453215579677623938493817524360235266729126963437965492174687933504,
        8145224086106388054819889077753705326815112983651887899343843409495561674761,
        240733345096957084288314443819536529671875879418851393724087813489828336128,
        7240594985073855112448671943124907453020112321119427239699743360808470712905,
        1922557478806811320114800272374145896101812840419235052039769846722274071770,
        22629787614116616624851879144194309044341917151734314799740917845628337525448,
        252885143911841106129286943632173819439944545186128417781262516016680976,
        10178806378524417231856993349326614975354206029870708105968959661626032981002,
        1017762628406940165449075979085372251986443850879704259043882319464540217993,
        2827211106377689776608572490932380323289971888838861081412864692380400128584,
        918981761771385902987382126930115159553353255765308153374457949001026899978,
        30478605821570397326523596896897966471406357077229600943555882081599882761,
        2728481625000464714156339865231935159060114469434353449567904679014413972032,
        8186030210446068796525688559033553602159578563807334295477000558180044911626,
        7253352863156205591565774766782477793736151946693137939964257580065436733441,
        259736938791926451006212354344970013273951339495427041375572792982485930049,
        922957605777756587666636474555940758810224355495396111644049836212870186050,
        9954886598351420380726243130644678972310639063321990513568086191354266550786,
        15717900389440178581050411274554185793367616004107187926344580365916183725129,
        1839320269482017250855259491597110474954065390855949091685963472622426554880,
        1837741871604000766145565650275092280690697955584935011502620888334986421248,
        7267345762114192585384255013569000005568925612003997294708848851820432883793,
        16398194811885115257586720785292264099617471041351907866721570739198687187528,
        1827199871953052090216432812178018710563731932730780778335159008410602864648,
        14489948157622333652658206877132637529004279196579908560043888337189708763656,
        1841117635336490732720903467594482045436116697540011142652947046692139635728,
        8155769988959550919832760135712503357507972131417032553617164877012360331777,
        7239300967729071523044720455644367359062293712157068081121431713678796788440,
        7477304556402702661143590316899631286273394976316106144576066426383412232768,
        7366019936328228935589309981452305266257521345326733553658556620901147748048,
        21957050193379490158664043420307904070429528467354577613303402930518318716416,
        91768351204427107680083774899412206781284516416,
    ]


#######################
## View Internal
#######################


@view
@internal
def _getAPACategory(tokenId: uint256) -> uint256:
    bitIndex: uint256 = tokenId % 85
    arrIndex: uint256 = tokenId / 85

    return bitwise_and(shift(allocation[arrIndex], -convert(bitIndex, int128) * 3), 7)


@view
@internal
def getAllocationFromCategory(category: uint256) -> uint256:
    if category == 0:  # common
        return as_wei_value(50, "ether")
    elif category == 1:  # rare
        return as_wei_value(84, "ether")
    elif category == 2:  # exceptional
        return as_wei_value(166, "ether")
    elif category == 3:  # epic
        return as_wei_value(416, "ether")
    elif category == 4:  # legendary
        return as_wei_value(2500, "ether")
    else:
        return 0


@view
@internal
def getRemainingAmount(tokenId: uint256, timeSinceStart: uint256) -> uint256:

    # 3 bits thus 7
    tokenAllocation: uint256 = self.getAllocationFromCategory(
        self._getAPACategory(tokenId)
    )

    if timeSinceStart >= self.vestingDuration:
        return tokenAllocation - self.taken[tokenId]
    else:
        return ((tokenAllocation * timeSinceStart) / self.vestingDuration) - self.taken[
            tokenId
        ]


#######################
## View External
#######################


@view
@external
def getAPACategory(tokenId: uint256) -> uint256:
    return self._getAPACategory(tokenId)


@view
@external
def claimable(ids: DynArray[uint256, 100]) -> uint256:
    totalAmount: uint256 = 0

    if block.timestamp < self.startTime:
        return 0

    timeSinceStart: uint256 = block.timestamp - self.startTime
    for id in ids:
        totalAmount += self.getRemainingAmount(id, timeSinceStart)
    return totalAmount


#######################
## External
#######################


@external
def claim(ids: DynArray[uint256, 100]):
    startTime: uint256 = self.startTime

    assert block.timestamp > startTime

    totalAmount: uint256 = 0
    timeSinceStart: uint256 = block.timestamp - startTime

    for id in ids:
        assert msg.sender == self.APA.ownerOf(id)

        # honoraries are not eligible
        assert id < 10_000

        amount: uint256 = self.getRemainingAmount(id, timeSinceStart)

        self.taken[id] += amount
        totalAmount += amount

    if totalAmount > 0:
        self.FLY.transfer(msg.sender, totalAmount)
